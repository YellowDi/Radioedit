--------------------------------------- 查看装备等级 Author: M-------------------------------------local LibEvent = LibStub:GetLibrary("LibEvent.7000")local LibSchedule = LibStub:GetLibrary("LibSchedule.7000")local LibItemInfo = LibStub:GetLibrary("LibItemInfo.7000")local slots = {    { index = 1, name = HEADSLOT, },    { index = 2, name = NECKSLOT, },    { index = 3, name = SHOULDERSLOT, },    { index = 5, name = CHESTSLOT, },    { index = 6, name = WAISTSLOT, },    { index = 7, name = LEGSSLOT, },    { index = 8, name = FEETSLOT, },    { index = 9, name = WRISTSLOT, },    { index = 10, name = HANDSSLOT, },    { index = 11, name = FINGER0SLOT, },    { index = 12, name = FINGER1SLOT, },    { index = 13, name = TRINKET0SLOT, },    { index = 14, name = TRINKET1SLOT, },    { index = 15, name = BACKSLOT, },    { index = 16, name = MAINHANDSLOT, },    { index = 17, name = SECONDARYHANDSLOT, },}--創建面板local function GetInspectItemListFrame(parent)    if (not parent.inspectFrame) then        local itemfont = "ChatFontNormal"        local backdrop = {            bgFile   = "Interface\\Tooltips\\UI-Tooltip-Background",            edgeFile = "Interface\\Tooltips\\UI-Tooltip-Border",            tile     = true,            tileSize = 8,            edgeSize = 16,            insets   = {left = 2, right = 2, top = 2, bottom = 2}        }        local frame = CreateFrame("Frame", nil, parent)        frame:SetSize(160, 424)        frame:SetFrameLevel(0)        frame:SetPoint("TOPLEFT", parent, "TOPRIGHT", 0, 0)        frame:SetBackdrop(backdrop)        frame:SetBackdropColor(0, 0, 0, 0.9)        frame:SetBackdropBorderColor(0.6, 0.6, 0.6)        frame.portrait = CreateFrame("Frame", nil, frame, "GarrisonFollowerPortraitTemplate")        frame.portrait:SetPoint("TOPLEFT", frame, "TOPLEFT", 18, -16)        frame.portrait:SetScale(0.8)        frame.title = frame:CreateFontString(nil, "ARTWORK", "GameFontNormalLargeOutline")        frame.title:SetPoint("TOPLEFT", frame, "TOPLEFT", 66, -18)        frame.level = frame:CreateFontString(nil, "ARTWORK", itemfont)        frame.level:SetPoint("TOPLEFT", frame, "TOPLEFT", 66, -42)        frame.level:SetFont(frame.level:GetFont(), 14, "THINOUTLINE")                local itemframe        local fontsize = GetLocale():sub(1,2) == "zh" and 12 or 9        backdrop.edgeSize = 1        backdrop.edgeFile = "Interface\\Buttons\\WHITE8X8"        backdrop.insets = {left = 1, right = 1, top = 1, bottom = 1}        for i, v in ipairs(slots) do            itemframe = CreateFrame("Button", nil, frame)            itemframe:SetSize(120, 342/#slots)            itemframe.index = v.index            if (i == 1) then                itemframe:SetPoint("TOPLEFT", frame, "TOPLEFT", 15, -70)            else                itemframe:SetPoint("TOPLEFT", frame["item"..(i-1)], "BOTTOMLEFT")            end            itemframe.label = CreateFrame("Frame", nil, itemframe)            itemframe.label:SetSize(36, 16)            itemframe.label:SetPoint("LEFT")            itemframe.label:SetBackdrop(backdrop)            itemframe.label:SetBackdropBorderColor(0, 0.9, 0.9, 0.2)            itemframe.label:SetBackdropColor(0, 0.9, 0.9, 0.2)            itemframe.label.text = itemframe.label:CreateFontString(nil, "ARTWORK")            itemframe.label.text:SetFont(UNIT_NAME_FONT, fontsize, "THINOUTLINE")            itemframe.label.text:SetSize(34, 14)            itemframe.label.text:SetPoint("CENTER", 1, 0)            itemframe.label.text:SetText(v.name)            itemframe.label.text:SetTextColor(0, 0.9, 0.9)            itemframe.levelString = itemframe:CreateFontString(nil, "ARTWORK", itemfont)            itemframe.levelString:SetPoint("LEFT", itemframe.label, "RIGHT", 4, 0)            itemframe.itemString = itemframe:CreateFontString(nil, "ARTWORK", itemfont)            itemframe.itemString:SetHeight(16)            itemframe.itemString:SetPoint("LEFT", itemframe.levelString, "RIGHT", 2, 0)            itemframe:SetScript("OnEnter", function(self)                local r, g, b, a = self.label:GetBackdropColor()                self.label:SetBackdropColor(r, g, b, a+0.5)                if (self.link or (self.level and self.level > 0)) then                    GameTooltip:SetOwner(self, "ANCHOR_RIGHT")                    GameTooltip:SetInventoryItem(self:GetParent().unit, self.index)                    GameTooltip:Show()                end            end)            itemframe:SetScript("OnLeave", function(self)                local r, g, b, a = self.label:GetBackdropColor()                self.label:SetBackdropColor(r, g, b, abs(a-0.5))                GameTooltip:Hide()            end)            itemframe:SetScript("OnDoubleClick", function(self)                if (self.link) then                    ChatEdit_ActivateChat(ChatEdit_ChooseBoxForSend())                    ChatEdit_InsertLink(self.link)                end            end)            frame["item"..i] = itemframe        end                frame.closeButton = CreateFrame("Button", nil, frame)        frame.closeButton:SetSize(12, 12)        frame.closeButton:SetScale(0.85)        frame.closeButton:SetPoint("BOTTOMLEFT", 5, 6)        frame.closeButton:SetNormalTexture("Interface\\Cursor\\Item")        frame.closeButton:GetNormalTexture():SetTexCoord(0, 12/32, 12/32, 0)        frame.closeButton:SetScript("OnClick", function(self)            self:GetParent():Hide()        end)                LibEvent:trigger("INSPECT_FRAME_CREATED", frame, parent)                parent:HookScript("OnHide", function(self) frame:Hide() end)        parent.inspectFrame = frame    end    return parent.inspectFrameendlocal ItemLevelPattern = gsub(ITEM_LEVEL, "%%d", "%%d")function ShowInspectItemListFrame(unit, parent, itemLevel)    if (not parent:IsShown()) then return end    local frame = GetInspectItemListFrame(parent)    local class = select(2, UnitClass(unit))    local color = RAID_CLASS_COLORS[class] or NORMAL_FONT_COLOR    frame.unit = unit    frame:SetBackdropBorderColor(color.r, color.g, color.b)    frame.portrait:SetLevel(UnitLevel(unit))    frame.portrait.PortraitRingQuality:SetVertexColor(color.r, color.g, color.b)    frame.portrait.LevelBorder:SetVertexColor(color.r, color.g, color.b)    SetPortraitTexture(frame.portrait.Portrait, unit)    frame.title:SetText(UnitName(unit))    frame.title:SetTextColor(color.r, color.g, color.b)    frame.level:SetText(format(ItemLevelPattern, itemLevel))    frame.level:SetTextColor(1, 0.82, 0)    local _, name, level, link, quality    local itemframe, mframe, oframe, itemwidth    local width = 160    for i, v in ipairs(slots) do        _, level, name, link, quality = LibItemInfo:GetUnitItemInfo(unit, v.index)        itemframe = frame["item"..i]        itemframe.name = name        itemframe.link = link        itemframe.level = level        itemframe.quality = quality        itemframe.itemString:SetWidth(0)        if (level > 0) then            itemframe.levelString:SetText(format("%3s",level))            itemframe.itemString:SetText(link or name)        else            itemframe.levelString:SetText(format("%3s",""))            itemframe.itemString:SetText("")        end        itemwidth = itemframe.itemString:GetWidth()        if (itemwidth > 200) then            itemwidth = 200            itemframe.itemString:SetWidth(itemwidth)        end        itemframe.width = itemwidth + 64        itemframe:SetWidth(itemframe.width)        if (width < itemframe.width) then            width = itemframe.width        end        if (v.index == 16) then            mframe = itemframe            mframe:SetAlpha(1)        elseif (v.index == 17) then            oframe = itemframe            oframe:SetAlpha(1)        end        LibEvent:trigger("ITEMFRAME_UPDATED", itemframe, quality)    end    if (mframe and oframe and (mframe.quality == 6 or oframe.quality == 6)) then        level = max(mframe.level, oframe.level)        if mframe.link then            mframe.levelString:SetText(format("%3s",level))        end        if oframe.link then            oframe.levelString:SetText(format("%3s",level))        end    end    if (mframe and mframe.level <= 0) then        mframe:SetAlpha(0.4)    end    if (oframe and oframe.level <= 0) then        oframe:SetAlpha(0.4)    end    frame:SetWidth(width + 36)    frame:Show()    LibEvent:trigger("INSPECT_FRAME_SHOWN", frame, parent, itemLevel)    return frameendlocal function onStart(self)    InspectFrame.progress:SetText("Reading...")endlocal function onTimeout(self)    InspectFrame.progress:SetText("Failed")endlocal function onSuccess(self)    InspectFrame.progress:SetText("")endlocal function onExecute(self)    if (not InspectFrame.unit or self.identity ~= UnitGUID(InspectFrame.unit)) then return end    local unknownCount, itemLevel = LibItemInfo:GetUnitItemLevel(InspectFrame.unit)    if (unknownCount == 0) then        onSuccess(self)        local parent = ShowInspectItemListFrame(InspectFrame.unit, InspectFrame, itemLevel)        LibEvent:trigger("ITEM_STATS", parent)        LibEvent:trigger("UNIT_INSPECT_READY", itemLevel)        LibSchedule:AwakeTask("Inspect.+Slot", true)        return true    endendlocal function AppendToBlizzardInspectUI()    if (not InspectFrame.progress) then        InspectFrame.progress = InspectPaperDollFrame:CreateFontString(nil, "OVERLAY", "GameFontNormalSmall")        InspectFrame.progress:SetPoint("RIGHT", InspectFrame.TitleText, "RIGHT", 48, -38)        InspectFrame.progress:SetJustifyH("RIGHT")        InspectFrame.progress:SetTextColor(0, 0.8, 0.8)    end    LibSchedule:AddTask({        identity  = UnitGUID(InspectFrame.unit),        timer     = 0.64,        elasped   = 1,        expired   = GetTime() + 5,        onStart   = onStart,        onTimeout = onTimeout,        onExecute = onExecute,    })end--為物品添加一個直角邊框local function AngularBorder(self, quality, itemIDOrLink)    if (not self) then return end    if (not self.angularBorder) then        local parent = self.IconBorder or self        self.angularBorderMask = CreateFrame("Frame", nil, self)        self.angularBorderMask:SetSize(parent:GetWidth()-2, parent:GetHeight()-2)        self.angularBorderMask:SetPoint("CENTER", parent, "CENTER")        self.angularBorderMask:SetBackdrop({edgeFile = "Interface\\Tooltips\\UI-Tooltip-Background", edgeSize = 2})        self.angularBorderMask:SetBackdropBorderColor(0, 0, 0)        self.angularBorderMask:Hide()        self.angularBorder = CreateFrame("Frame", nil, self)        self.angularBorder:SetSize(parent:GetWidth(), parent:GetHeight())        self.angularBorder:SetPoint("CENTER", parent, "CENTER")        self.angularBorder:SetBackdrop({edgeFile = "Interface\\Buttons\\WHITE8X8", edgeSize = 1})        self.angularBorder:Hide()    end    LibEvent:trigger("ITEM_ANGULARBORDER", self, quality)end--此函數會修改大部分物品按鈕hooksecurefunc("SetItemButtonQuality", AngularBorder)--打開玩家面板的時候顯示物品列表PaperDollFrame:HookScript("OnShow", function(self)    ShowInspectItemListFrame("player", self, select(2,GetAverageItemLevel()))end)--玩家等級變更時LibEvent:attachEvent("UNIT_LEVEL", function(this, arg1)    if (arg1 == "player" and CharacterFrame:IsShown()) then        ShowInspectItemListFrame("player", PaperDollFrame, select(2,GetAverageItemLevel()))    endend)--玩家裝備更換時LibEvent:attachEvent("PLAYER_EQUIPMENT_CHANGED", function(this)    if (CharacterFrame:IsShown()) then        ShowInspectItemListFrame("player", PaperDollFrame, select(2,GetAverageItemLevel()))    endend)--單位裝備更換時LibEvent:attachEvent("UNIT_INVENTORY_CHANGED", function(this)    if (InspectFrame and InspectFrame.unit and arg1 == InspectFrame.unit) then        AppendToBlizzardInspectUI()    endend)--指定的插件載入時LibEvent:attachEvent("ADDON_LOADED", function(this, arg1)    if (arg1 == "Blizzard_InspectUI") then        hooksecurefunc("InspectFrame_UpdateTabs", function()            if (not InspectFrame.unit) then return end            AppendToBlizzardInspectUI()        end)        hooksecurefunc("InspectPaperDollItemSlotButton_Update", function(self)            local textureName = GetInventoryItemTexture(InspectFrame.unit, self:GetID())            if (not textureName) then AngularBorder(self, false) end        end)    endend)------------------  TRIGGERS  --------------------執行TRIGGER事件[物品直角邊框]: 設置物品直角邊框LibEvent:attachTrigger("ITEM_ANGULARBORDER", function(this, self, quality)    if (TinyInspectDB and TinyInspectDB.showItemRectangularBorder) then        if (quality and quality > 1) then            local r, g, b = GetItemQualityColor(quality)            self.angularBorder:Show()            self.angularBorder:SetBackdropBorderColor(r, g, b)        else            self.angularBorder:Hide()        end        self.angularBorderMask:Show()    else        self.angularBorderMask:Hide()        self.angularBorder:Hide()    endend)--執行TRIGGER事件[物品列表的物品更新后]: 高亮顯示橙裝和武器LibEvent:attachTrigger("ITEMFRAME_UPDATED", function(this, itemframe, quality)    local r, g, b = 0, 0.9, 0.9    if (TinyInspectDB and TinyInspectDB.showColoredLabel) then        if (quality and quality > 4) then            r, g, b = GetItemQualityColor(quality or 0)        elseif (itemframe.name and not itemframe.link) then            r, g, b = 0.9, 0.8, 0.4        elseif (not itemframe.link) then            r, g, b = 0.5, 0.5, 0.5        end    end    itemframe.label:SetBackdropBorderColor(r, g, b, 0.2)    itemframe.label:SetBackdropColor(r, g, b, 0.2)    itemframe.label.text:SetTextColor(r, g, b)end)--執行TRIGGER事件[物品列表面板]: 重設位置和背景LibEvent:attachTrigger("INSPECT_FRAME_CREATED", function(this, frame, parent)    if (TinyInspectDB and TinyInspectDB.showRectangularFrame) then        frame:SetPoint("TOPLEFT", parent, "TOPRIGHT", 2, 0)        frame:SetBackdrop({            bgFile   = "Interface\\Tooltips\\UI-Tooltip-Background",            edgeFile = "Interface\\Buttons\\WHITE8X8",            tile     = true,            tileSize = 8,            edgeSize = 1,            insets   = {left = 1, right = 1, top = 1, bottom = 1}        })        frame:SetBackdropColor(0, 0, 0, 0.9)    endend)--執行TRIGGER事件[物品屬性統計面板顯示]: 屬性統計面板LibEvent:attachTrigger("ITEM_STATS", function(this, parent)    if (not parent) then return end    if (TinyInspectDB and TinyInspectDB.showInspectCompare) then        local playerFrame = ShowInspectItemListFrame("player", parent, select(2,GetAverageItemLevel()))        if (parent.statsFrame) then            parent.statsFrame:SetParent(playerFrame)        end    elseif (parent.statsFrame) then        parent.statsFrame:SetParent(parent)    end    if (parent.statsFrame) then        parent.statsFrame:SetPoint("TOPLEFT", parent.statsFrame:GetParent(), "TOPRIGHT", 1, -1)    endend)